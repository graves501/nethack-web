<!-- Simple UI for testing -->
<!-- <button onclick="select()">Send</button> -->

<div style="width: 100%; height: 100%; display: flex">
  <div style="display: flex; flex-direction: column; flex-grow: 1">
    <pre style="flex-grow: 1; overflow-y: auto" id="dialog"></pre>
    <pre style="height: 10rem; overflow-y: auto" id="output"></pre>
  </div>

  <div style="display: flex; flex-direction: column">
    <pre style="flex-grow: 1; overflow-y: auto" id="inventory"></pre>

    <pre style="height: 10rem; overflow-y: auto" id="status"></pre>
  </div>
</div>

<script>
  document.onkeypress = (e) => {
    if (e.ctrlKey) return; // should have been processed in keydown
    e.preventDefault();

    window.nethackJS.sendInput(e.charCode || e.keyCode);
  };

  document.onkeydown = (e) => {
    if (!e.ctrlKey) return; // key events without ctrl is handled in `keypress` events
    if (e.keyCode == 17) return; // ctrl is pressed down
    e.preventDefault();

    var code = e.charCode || e.keyCode;
    // some browsers do not `apply` the control key to charCode
    if (code >= 65 && code <= 90) {
      // A~Z
      code = code - 64;
    } else if (code >= 97 && code <= 122) {
      code = code - 96;
    }
    window.nethackJS.sendInput(code);
  };

  const dialog = document.querySelector("#dialog");
  const output = document.querySelector("#output");
  const inventory = document.querySelector("#inventory");
  const status = document.querySelector("#status");

  const clear = (elem) => Array.from(elem.children).forEach((c) => elem.removeChild(c));
  const createItemList = (items) => {
    const list = document.createElement("ul");
    list.style.listStyleType = "none";
    items
      .map((i) => {
        const elem = document.createElement("li");
        elem.style.fontWeight = i.active ? "bold" : "";
        if (i.identifier === 0) {
          elem.innerHTML = i.str;
          elem.style.fontSize = "1.1rem";
          elem.style.margin = "0.5rem 0";
        } else {
          elem.innerHTML = `${String.fromCharCode(i.accelerator)} - ${i.str}`;
        }
        return elem;
      })
      .forEach((i) => list.appendChild(i));
    return list;
  };
  const createMenu = (items, count) => {
    const list = document.createElement("div");
    list.style = "display: flex; flex-direction: column;";
    list.id = "menu";

    items.forEach((i) => {
      const div = document.createElement("div");
      const elem = document.createElement("input");
      const label = document.createElement("label");
      const id = `menu-${i.identifier}`;
      const accel = String.fromCharCode(i.accelerator);
      elem.type = count === 1 ? "radio" : "checkbox";
      elem.name = "menuSelect";
      elem.id = id;
      elem.disabled = i.identifier === 0;
      elem.checked = i.active;
      elem.value = i.identifier;
      label.htmlFor = id;
      label.innerHTML = `${accel ? accel + " - " : ""}${i.str}`;

      div.appendChild(elem);
      div.appendChild(label);
      list.appendChild(div);
    });

    return list;
  };
  const createDialogText = (text) => {
    const p = document.createElement("p");
    p.appendChild(document.createTextNode(text));
    dialog.appendChild(p);
  };
  const appendOutputLine = (line) => {
    output.innerHTML += line;
    output.scrollTo(0, output.scrollHeight);
  };

  window.nethackGodot = {
    openMenu(winid, prompt, count, ...items) {
      clear(dialog);

      const elem = document.createElement("div");
      elem.innerHTML = prompt;
      dialog.appendChild(elem);

      dialog.appendChild(createMenu(items, count));

      const btn = document.createElement("button");
      btn.innerHTML = "Submit";
      btn.onclick = () => {
        const inputs = Array.from(document.querySelectorAll("#menu input"));
        console.log(inputs);
        const ids = inputs.filter((i) => i.checked && !i.disabled).map((i) => parseInt(i.value));
        window.nethackJS.selectMenu(ids);
      };

      dialog.appendChild(btn);
    },

    openQuestion: (question, ...choices) => appendOutputLine(`\n${question} ${choices}\n`),
    openDialog: (winid, text) => createDialogText(text),
    printLine: (line) => appendOutputLine(line + "\n"),
    closeDialog: (winid) => clear(dialog),

    moveCursor(x, y) {},
    centerView(x, y) {},
    updateMap(...tiles) {},

    updateStatus(s) {
      status.innerHTML = `Web_user ${s.title} ${s.align}`; // TODO: set player name
      status.innerHTML += `\nStr: ${s.str} Dex: ${s.dex} Con: ${s.con} Int: ${s.int} Wis: ${s.wis} Cha: ${s.cha}`;
      status.innerHTML += `\nDlvl ${s.dungeonLvl} HP: ${s.hp}/${s.hpMax} Pw: ${s.power}/${s.powerMax} AC: ${s.armor} EXP: ${s.expLvl} $: ${s.gold}`;
    },
    updateInventory(...items) {
      clear(inventory);
      inventory.appendChild(createItemList(items));
    },
  };

  // setTimeout(() => {
  //   const dataContainer = document.querySelector("#data");
  //   const values = window.nethackGlobal.constants;
  //   Object.keys(values).forEach((key) => {
  //     const value = values[key];
  //     const div = document.createElement("div");

  //     Object.keys(value)
  //       .filter((x) => isNaN(parseInt(x)))
  //       .forEach((key) => {
  //         const child = document.createElement("div");
  //         child.innerHTML = `${key}: ${value[key]}`;
  //         div.appendChild(child);
  //       });

  //     dataContainer.appendChild(div);
  //   });
  // }, 2000);
</script>
<script src="./nethack.js"></script>
